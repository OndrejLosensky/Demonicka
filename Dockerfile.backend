# Use Node 20
FROM node:20

# Set working directory to root
WORKDIR /root

# Copy root package.json and lockfile
COPY package.json pnpm-lock.yaml* ./

# Install pnpm globally
RUN npm install -g pnpm

# Install dependencies
RUN pnpm install --frozen-lockfile

# Install Prisma CLI globally
RUN pnpm add -g prisma

# Copy the rest of the repo
COPY . .

# Build only the server
RUN pnpm build:server

# Expose the port the server uses
EXPOSE 3000

# Start the server
CMD ["pnpm", "start:server"]
