// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  SUPER_ADMIN
  OPERATOR
  USER
  PARTICIPANT
}

enum Gender {
  MALE
  FEMALE
}

enum DeviceType {
  ios
  android
  web
}

enum AchievementType {
  EVENT_WIN
  BEERS_IN_EVENT
  BEERS_IN_HOUR
  EVENTS_PARTICIPATED
  TOTAL_BEERS
  CONSECUTIVE_DAYS
  FIRST_BEER
  MILESTONE
  BEER_PONG_GAMES_PLAYED
  BEER_PONG_GAMES_WON
  BEER_PONG_FINALS_WON
}

enum AchievementCategory {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
  LEGENDARY
}

enum BeerPongEventStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum BeerPongGameStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum BeerPongRound {
  QUARTERFINAL
  SEMIFINAL
  FINAL
}

enum CancellationPolicy {
  KEEP_BEERS
  REMOVE_BEERS
}

enum EventRegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Models
model User {
  id                     String    @id @default(uuid()) @db.Uuid
  username               String?   @unique
  password               String?
  email                  String?
  googleId                String?   @unique
  name                   String?
  firstName              String?
  lastName               String?
  gender                 Gender
  role                   UserRole  @default(PARTICIPANT)
  beerCount              Int       @default(0)
  lastBeerTime           DateTime? @db.Timestamptz(6)
  registrationToken      String?   @unique
  isRegistrationComplete Boolean   @default(false)
  isTwoFactorEnabled     Boolean   @default(false)
  twoFactorSecret        String?
  canLogin               Boolean   @default(true)
  createdBy              String?   @db.Uuid
  allowedIPs             String[]  @default([])
  lastAdminLogin         DateTime? @db.Timestamptz(6)
  profilePictureUrl      String?
  googleProfilePictureUrl String?
  preferredTheme         String?
  createdAt              DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt              DateTime? @db.Timestamptz(6)

  // Relations
  beers                 Beer[]
  refreshTokens         RefreshToken[]
  deviceTokens          DeviceToken[]
  eventBeers            EventBeer[]
  userAchievements      UserAchievement[]
  events                EventUsers[]
  createdUsers          User[]             @relation("UserCreator")
  createdEvents         Event[]
  createdBeerPongEvents BeerPongEvent[]    @relation("BeerPongEventCreator")
  beerPongTeams              BeerPongTeam[]         @relation("BeerPongTeamPlayer1")
  beerPongTeams2             BeerPongTeam[]         @relation("BeerPongTeamPlayer2")
  eventBeerPongTeamsAsP1     EventBeerPongTeam[]    @relation("EventBeerPongTeamPlayer1")
  eventBeerPongTeamsAsP2     EventBeerPongTeam[]    @relation("EventBeerPongTeamPlayer2")
  beerPongGameBeers          BeerPongGameBeer[]
  startedBeerPongGames       BeerPongGame[]
  matchedRegistrations       EventRegistration[]
  twoFactorCodes             TwoFactorCode[]

  creator User? @relation("UserCreator", fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([email])
  @@index([googleId])
}

model RefreshToken {
  id            String   @id @default(uuid()) @db.Uuid
  token         String   @unique
  userId        String   @db.Uuid
  expiresAt     DateTime @db.Timestamptz(6)
  isRevoked     Boolean  @default(false)
  reasonRevoked String?
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model DeviceToken {
  id               String     @id @default(uuid()) @db.Uuid
  token            String
  deviceType       DeviceType @default(web)
  deviceName       String?
  deviceModel      String?
  osVersion        String?
  isActive         Boolean    @default(true)
  lastUsed         DateTime?  @db.Timestamptz(6)
  userId           String     @db.Uuid
  isAdminDevice    Boolean    @default(false)
  biometricEnabled Boolean?
  createdAt        DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime   @updatedAt @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Barrel {
  id             String    @id @default(uuid()) @db.Uuid
  size           Int // 15, 30, or 50
  isActive       Boolean   @default(false)
  orderNumber    Int
  remainingBeers Int
  totalBeers     Int
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt      DateTime? @db.Timestamptz(6)

  // Relations
  beers      Beer[]
  eventBeers EventBeer[]
  events     EventBarrels[]
}

model Beer {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  barrelId  String?   @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  barrel Barrel? @relation(fields: [barrelId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([barrelId])
}

model Event {
  id                   String    @id @default(uuid()) @db.Uuid
  name                 String
  description          String?
  startDate            DateTime  @db.Timestamptz(6)
  endDate              DateTime  @db.Timestamptz(6)
  isActive             Boolean   @default(false)
  registrationEnabled  Boolean   @default(false)
  registrationToken    String?   @unique
  createdBy            String?   @db.Uuid
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt            DateTime? @db.Timestamptz(6)

  // Relations
  eventBeers          EventBeer[]
  users               EventUsers[]
  barrels             EventBarrels[]
  beerPongEvents      BeerPongEvent[]
  eventBeerPongTeams  EventBeerPongTeam[]
  eventRegistrations  EventRegistration[]
  creator             User?      @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
}

/// Teams registered at Event level; reusable across BeerPongEvents (tournaments) in the same event.
model EventBeerPongTeam {
  id        String    @id @default(uuid()) @db.Uuid
  eventId   String    @db.Uuid
  name      String
  player1Id String    @db.Uuid
  player2Id String    @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt DateTime? @db.Timestamptz(6)

  // Relations
  event          Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  player1        User           @relation("EventBeerPongTeamPlayer1", fields: [player1Id], references: [id])
  player2        User           @relation("EventBeerPongTeamPlayer2", fields: [player2Id], references: [id])
  beerPongTeams  BeerPongTeam[]

  @@unique([eventId, name])
  @@index([eventId])
  @@index([player1Id])
  @@index([player2Id])
}

model EventBeer {
  id         String    @id @default(uuid()) @db.Uuid
  eventId    String    @db.Uuid
  userId     String    @db.Uuid
  barrelId   String?   @db.Uuid
  spilled    Boolean   @default(false)
  consumedAt DateTime  @default(now()) @db.Timestamptz(6)
  deletedAt  DateTime? @db.Timestamptz(6)

  event             Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  barrel            Barrel?            @relation(fields: [barrelId], references: [id], onDelete: Cascade)
  beerPongGameBeers BeerPongGameBeer[]

  @@index([eventId])
  @@index([userId])
  @@index([barrelId])
}

model Achievement {
  id             String              @id
  name           String
  description    String?
  type           AchievementType
  category       AchievementCategory @default(BEGINNER)
  targetValue    Int
  points         Int                 @default(0)
  icon           String?
  isActive       Boolean             @default(true)
  isRepeatable   Boolean             @default(false)
  maxCompletions Int                 @default(1)
  createdAt      DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime            @updatedAt @db.Timestamptz(6)
  deletedAt      DateTime?           @db.Timestamptz(6)

  // Relations
  userAchievements UserAchievement[]
}

model UserAchievement {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @db.Uuid
  achievementId      String
  progress           Int       @default(0)
  isCompleted        Boolean   @default(false)
  completedAt        DateTime? @db.Timestamptz(6)
  completionCount    Int       @default(0)
  lastProgressUpdate DateTime? @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt          DateTime? @db.Timestamptz(6)

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

// Many-to-many relation tables
model EventUsers {
  eventId String @db.Uuid
  userId  String @db.Uuid

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@index([userId])
}

model EventBarrels {
  eventId  String @db.Uuid
  barrelId String @db.Uuid

  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  barrel Barrel @relation(fields: [barrelId], references: [id], onDelete: Cascade)

  @@id([eventId, barrelId])
  @@index([barrelId])
}

model EventRegistration {
  id               String                 @id @default(uuid()) @db.Uuid
  eventId          String                 @db.Uuid
  rawName          String
  participating    Boolean                @default(true)
  arrivalTime      DateTime?              @db.Timestamptz(6)
  leaveTime        DateTime?              @db.Timestamptz(6)
  matchedUserId    String?                @db.Uuid
  matchConfidence  Decimal?               @db.Decimal(5, 4)
  status           EventRegistrationStatus @default(PENDING)
  createdAt        DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime               @updatedAt @db.Timestamptz(6)

  event        Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  matchedUser  User? @relation(fields: [matchedUserId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([status])
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // SUPER_ADMIN, OPERATOR, USER, PARTICIPANT
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // CREATE_EVENT, UPDATE_EVENT, etc.
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  roles RolePermission[]
}

model RolePermission {
  roleId       String @db.Uuid
  permissionId String @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique // SHOW_DELETED_USERS, etc.
  enabled     Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
}

/// Global defaults for Beer Pong tournaments (single-row table managed by the system settings UI).
model BeerPongDefaults {
  id                 String             @id @default(uuid()) @db.Uuid
  beersPerPlayer     Int                @default(2)
  timeWindowMinutes  Int                @default(5)
  undoWindowMinutes  Int                @default(5)
  cancellationPolicy CancellationPolicy @default(KEEP_BEERS)
  updatedBy          String?            @db.Uuid
  createdAt          DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime           @updatedAt @db.Timestamptz(6)

  @@index([updatedBy])
}

model BeerPongEvent {
  id                 String              @id @default(uuid()) @db.Uuid
  eventId            String              @db.Uuid
  name               String
  description        String?
  status             BeerPongEventStatus @default(DRAFT)
  beersPerPlayer     Int                 @default(2)
  timeWindowMinutes  Int                 @default(5)
  undoWindowMinutes  Int                 @default(5)
  cancellationPolicy CancellationPolicy  @default(KEEP_BEERS)
  startedAt          DateTime?           @db.Timestamptz(6)
  completedAt        DateTime?           @db.Timestamptz(6)
  createdBy          String?             @db.Uuid
  createdAt          DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @db.Timestamptz(6)
  deletedAt          DateTime?           @db.Timestamptz(6)

  // Relations
  event   Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  teams   BeerPongTeam[]
  games   BeerPongGame[]
  creator User?          @relation("BeerPongEventCreator", fields: [createdBy], references: [id])

  @@index([eventId])
  @@index([createdBy])
}

model BeerPongTeam {
  id                   String    @id @default(uuid()) @db.Uuid
  beerPongEventId      String    @db.Uuid
  eventBeerPongTeamId  String?   @db.Uuid  // Optional: links to event-level team when reusing
  name                 String
  player1Id            String    @db.Uuid
  player2Id            String    @db.Uuid
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  deletedAt            DateTime? @db.Timestamptz(6)

  // Relations
  beerPongEvent      BeerPongEvent      @relation(fields: [beerPongEventId], references: [id], onDelete: Cascade)
  eventBeerPongTeam  EventBeerPongTeam? @relation(fields: [eventBeerPongTeamId], references: [id], onDelete: SetNull)
  player1            User                @relation("BeerPongTeamPlayer1", fields: [player1Id], references: [id])
  player2            User                @relation("BeerPongTeamPlayer2", fields: [player2Id], references: [id])
  gamesAsTeam1       BeerPongGame[]      @relation("BeerPongGameTeam1")
  gamesAsTeam2       BeerPongGame[]      @relation("BeerPongGameTeam2")
  gamesWon           BeerPongGame[]      @relation("BeerPongGameWinner")

  @@unique([beerPongEventId, name])
  @@index([beerPongEventId])
  @@index([eventBeerPongTeamId])
  @@index([player1Id])
  @@index([player2Id])
}

model BeerPongGame {
  id              String             @id @default(uuid()) @db.Uuid
  beerPongEventId String             @db.Uuid
  round           BeerPongRound
  team1Id         String?            @db.Uuid
  team2Id         String?            @db.Uuid
  winnerTeamId    String?            @db.Uuid
  status          BeerPongGameStatus @default(PENDING)
  startedAt       DateTime?          @db.Timestamptz(6)
  endedAt         DateTime?          @db.Timestamptz(6)
  durationSeconds Int?
  startedBy       String?            @db.Uuid
  beersAddedAt    DateTime?          @db.Timestamptz(6)
  createdAt       DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @db.Timestamptz(6)

  // Relations
  beerPongEvent BeerPongEvent      @relation(fields: [beerPongEventId], references: [id], onDelete: Cascade)
  team1         BeerPongTeam?      @relation("BeerPongGameTeam1", fields: [team1Id], references: [id])
  team2         BeerPongTeam?      @relation("BeerPongGameTeam2", fields: [team2Id], references: [id])
  winnerTeam    BeerPongTeam?      @relation("BeerPongGameWinner", fields: [winnerTeamId], references: [id])
  gameBeers     BeerPongGameBeer[]
  startedByUser User?              @relation(fields: [startedBy], references: [id])

  @@index([beerPongEventId])
  @@index([team1Id])
  @@index([team2Id])
  @@index([winnerTeamId])
  @@index([round])
}

model BeerPongGameBeer {
  id             String   @id @default(uuid()) @db.Uuid
  beerPongGameId String   @db.Uuid
  userId         String   @db.Uuid
  eventBeerId    String   @db.Uuid
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  beerPongGame BeerPongGame @relation(fields: [beerPongGameId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  eventBeer    EventBeer    @relation(fields: [eventBeerId], references: [id])

  @@unique([beerPongGameId, userId, eventBeerId])
  @@index([beerPongGameId])
  @@index([userId])
  @@index([eventBeerId])
}

model TwoFactorCode {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  code      String
  expiresAt DateTime @db.Timestamptz(6)
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}
